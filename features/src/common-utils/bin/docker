#!/bin/bash
set -e

# Check if docker is installed
if ! command -v docker &>/dev/null; then
  echo "Error: Docker is not installed or not in PATH."
  exit 1
fi

# Check for privileged mode
is_privileged() {
  # Try to create a device node (requires CAP_SYS_ADMIN, usually only in privileged)
  if mknod /tmp/testnode c 1 3 2>/dev/null; then
    rm /tmp/testnode
    return 0
  fi

  # Fallback: check for /proc/1/root being accessible (often only in privileged)
  if [ -r /proc/1/root ]; then
    return 0
  fi

  # Fallback: check for "CapEff" in /proc/self/status (look for all bits set)
  if grep -q '^CapEff:\s*ffffffffffffffff' /proc/self/status 2>/dev/null; then
    return 0
  fi

  return 1
}

if ! is_privileged; then
  echo "Error: Container is not running in privileged mode. Please start with --privileged."
  exit 2
fi

# If all checks pass, exec docker with passed arguments
exec docker "$@"
