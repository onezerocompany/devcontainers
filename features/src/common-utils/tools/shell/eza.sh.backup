#!/bin/bash
set -e

# Source utils functions
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "${SCRIPT_DIR}/../../lib/utils.sh"

install_eza() {
    local INSTALL_EZA=${1:-true}

    if [ "$INSTALL_EZA" != "true" ]; then
        echo "  ‚ö†Ô∏è  eza installation skipped"
        return 0
    fi

    echo "üìã Installing eza (modern ls)..."

    # Add eza repository and install
    local EZA_KEY_URL="https://raw.githubusercontent.com/eza-community/eza/main/deb.asc"
    echo "  üì• Downloading eza GPG key from: $EZA_KEY_URL"
    
    if curl -fsSL "$EZA_KEY_URL" -o /tmp/eza.asc; then
        if [ -s /tmp/eza.asc ] && grep -q "BEGIN PGP PUBLIC KEY BLOCK" /tmp/eza.asc; then
            mkdir -p /etc/apt/keyrings
            gpg --dearmor < /tmp/eza.asc > /etc/apt/keyrings/gierens.gpg
            echo "deb [signed-by=/etc/apt/keyrings/gierens.gpg] http://deb.gierens.de stable main" | tee /etc/apt/sources.list.d/gierens.list
            chmod 644 /etc/apt/keyrings/gierens.gpg /etc/apt/sources.list.d/gierens.list
            
            if apt-get update && apt-get install -y eza; then
                echo "  ‚úì eza installed successfully from repository"
            else
                echo "  ‚ö†Ô∏è  Failed to install eza from repository"
                rm -f /etc/apt/keyrings/gierens.gpg /etc/apt/sources.list.d/gierens.list
                rm -f /tmp/eza.asc
                return 1
            fi
        else
            echo "  ‚ö†Ô∏è  Downloaded file is not a valid GPG key"
            rm -f /tmp/eza.asc
            return 1
        fi
        rm -f /tmp/eza.asc
    else
        echo "  ‚ö†Ô∏è  Failed to download eza GPG key"
        rm -f /tmp/eza.asc
        return 1
    fi

    # Always setup aliases
    setup_eza_aliases
}

setup_eza_aliases() {
    echo "  üîß Setting up eza aliases..."
    
    # Replace standard ls commands with eza
    add_alias "eza" "ls" "eza"
    add_alias "eza" "ll" "eza -l"
    add_alias "eza" "la" "eza -la"
    add_alias "eza" "lt" "eza --tree"
    add_alias "eza" "tree" "eza --tree"
    add_alias "eza" "l" "eza -lah"
    add_alias "eza" "lh" "eza -lah"
    add_alias "eza" "lg" "eza -la --git"
    
    echo "  ‚úì eza aliases configured"
}

# Check if eza should be installed (individual option or shell bundle)
if ! should_install_tool "EZA" "SHELLBUNDLE"; then
    echo "  ‚è≠Ô∏è  Skipping eza installation (disabled)"
    return 0
fi

# Run installation
install_eza "true"