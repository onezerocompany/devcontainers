# Development Setup Guide

This guide helps you set up your development environment for contributing to OneZero DevContainers.

## Prerequisites

- Docker Desktop or Docker Engine (20.10+)
- VS Code with Remote-Containers extension
- Git
- Basic knowledge of Docker and DevContainers

## Getting Started

### 1. Clone the Repository

```bash
git clone https://github.com/onezerocompany/devcontainers.git
cd devcontainers
```

### 2. Development Environment Setup

You can use our own devcontainer for development:

```bash
# Open in VS Code
code .

# Reopen in container when prompted
# Or use Command Palette: "Remote-Containers: Reopen in Container"
```

## Project Structure

```
devcontainers/
├── .github/workflows/    # CI/CD pipelines
├── features/            # DevContainer features
│   ├── src/            # Feature definitions
│   └── test/           # Feature tests
├── images/             # Docker images
│   ├── base/           # Base Ubuntu image
│   ├── dind/           # Docker-in-Docker
│   ├── devcontainer-base/  # DevContainer foundation
│   ├── firebase-toolkit/   # Firebase tools
│   └── runner/         # GitHub Actions runner
└── devcontainers/      # Pre-configured setups
```

## Development Workflows

### Working with Features

#### Creating a New Feature

1. Create feature directory:
```bash
mkdir -p features/src/my-feature
cd features/src/my-feature
```

2. Create required files:
- `devcontainer-feature.json` - Feature metadata
- `install.sh` - Installation script
- `README.md` - Documentation

3. Create test directory:
```bash
mkdir -p features/test/my-feature
```

4. Add test script:
```bash
#!/bin/bash
source dev-container-features-test-lib

check "tool-version" tool --version

reportResults
```

#### Testing Features Locally

```bash
# Test a specific feature
cd features/test/my-feature
./test.sh

# Run all feature tests
devcontainer features test \
  --base-image mcr.microsoft.com/devcontainers/base:ubuntu \
  --features ./features/src \
  --skip-autogenerated
```

### Working with Docker Images

#### Building Images Locally

```bash
# Build base image first
docker build -t ghcr.io/onezerocompany/base:local ./images/base

# Build dependent images
docker build -t ghcr.io/onezerocompany/dind:local ./images/dind
docker build -t ghcr.io/onezerocompany/devcontainer-base:local ./images/devcontainer-base

# Build with specific platform
docker build --platform linux/amd64 -t image:local ./images/base
```

#### Testing Images

```bash
# Run interactive shell
docker run -it --rm ghcr.io/onezerocompany/base:local

# Test with a devcontainer
devcontainer up --workspace-folder . \
  --config .devcontainer/test/devcontainer.json
```

## Testing Guidelines

### Feature Tests

1. **Basic functionality**: Verify tool installs and runs
2. **Version checks**: Ensure correct versions
3. **User permissions**: Test as non-root user
4. **Options**: Test all feature options
5. **Integration**: Test with other features

Example test structure:
```bash
#!/bin/bash
set -e

# Source test library
source dev-container-features-test-lib

# Test basic functionality
check "tool exists" which tool
check "tool version" tool --version

# Test feature options
check "option works" test -f /expected/path

# Report results
reportResults
```

### Image Tests

Use container-structure-test for image validation:

```bash
# Install container-structure-test
curl -LO https://storage.googleapis.com/container-structure-test/latest/container-structure-test-linux-amd64
chmod +x container-structure-test-linux-amd64

# Create test config
cat > test-config.yaml <<EOF
schemaVersion: 2.0.0
commandTests:
  - name: "User exists"
    command: "id"
    args: ["zero"]
    exitCode: 0
EOF

# Run tests
./container-structure-test-linux-amd64 test \
  --image ghcr.io/onezerocompany/base:local \
  --config test-config.yaml
```

## Debugging

### Feature Installation Issues

1. Add debugging to install.sh:
```bash
set -x  # Enable debug output
echo "Debug: Current user: $(whoami)"
echo "Debug: PATH: $PATH"
```

2. Test in isolation:
```bash
docker run -it -v $(pwd):/feature ubuntu:22.04 bash
/feature/install.sh
```

### Image Build Issues

1. Build with progress output:
```bash
docker build --progress=plain --no-cache -t test:local .
```

2. Debug specific layers:
```bash
# Build up to specific stage
docker build --target stage-name -t debug:local .

# Inspect intermediate containers
docker run -it --rm debug:local bash
```

## Common Issues

### Permission Errors

- Ensure scripts have execute permissions: `chmod +x install.sh`
- Use `sudo` appropriately in install scripts
- Test with different user configurations

### Path Issues

- Always use absolute paths in Dockerfiles
- Set PATH correctly in feature scripts
- Use `which` to verify tool locations

### Platform Compatibility

- Test on both amd64 and arm64
- Use platform-specific conditions when needed
- Document platform limitations

## Submitting Changes

1. Create feature branch
2. Make changes and test thoroughly
3. Update documentation and CHANGELOG.md
4. Run PR validation locally:
```bash
# Simulate PR checks
.github/workflows/scripts/validate-features.sh
```

5. Submit PR with clear description

## Additional Resources

- [DevContainer Features Specification](https://containers.dev/implementors/features/)
- [Docker Best Practices](https://docs.docker.com/develop/dev-best-practices/)
- [GitHub Actions Documentation](https://docs.github.com/en/actions)