name: Build and Publish Images & Features

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *" # Run every day at 3am
  push:
    branches:
      - main

jobs:
  # Base images that don't depend on other internal images
  base-images:
    name: Build and Publish ${{ matrix.image.name }} Image
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        image:
          - name: dev:base
            context: ./images/dev:base
            tag: dev-base
            tag-aliases: base
          - name: settings-gen
            context: ./images/settings-gen
            tag: settings-gen

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: Log into GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.image.context }}
          platforms: linux/amd64,linux/arm64
          cache-to: type=registry,ref=ghcr.io/${{ github.repository_owner }}/${{ matrix.image.tag }}:buildcache
          cache-from: type=registry,ref=ghcr.io/${{ github.repository_owner }}/${{ matrix.image.tag }}:buildcache,mode=max
          tags: |
            ghcr.io/${{ github.repository_owner }}/${{ matrix.image.tag }}:latest
            ${{ matrix.image.name == 'dev:base' && format('ghcr.io/{0}/devcontainers/dev:latest', github.repository_owner) || '' }}
            ${{ matrix.image.name == 'dev:base' && format('ghcr.io/{0}/dev:base', github.repository_owner) || '' }}
            ${{ matrix.image.name == 'dev:base' && format('ghcr.io/{0}/dev-base', github.repository_owner) || '' }}
            ${{ matrix.image.name == 'dev:base' && format('ghcr.io/{0}/base', github.repository_owner) || '' }}
            ${{ matrix.image.tag-aliases && format('ghcr.io/{0}/{1}:latest', github.repository_owner, matrix.image.tag-aliases) || '' }}
          push: true

  # Layer 2: Images that depend on dev:base
  layer2-images:
    name: Build and Publish ${{ matrix.image.name }} Image
    runs-on: ubuntu-latest
    needs: [base-images]
    strategy:
      fail-fast: false
      matrix:
        image:
          - name: dev:dind
            context: ./images/dev:dind
            tag: base
            tag-suffix: docker
          - name: devcontainer:base
            context: ./images/devcontainer:base
            tag: devcontainer
            tag-suffix: base
          - name: runner
            context: ./images/runner
            tag: runner

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: Log into GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.image.context }}
          platforms: linux/amd64,linux/arm64
          cache-to: type=registry,ref=ghcr.io/${{ github.repository_owner }}/${{ matrix.image.tag }}:${{ matrix.image.tag-suffix || 'latest' }}-buildcache
          cache-from: type=registry,ref=ghcr.io/${{ github.repository_owner }}/${{ matrix.image.tag }}:${{ matrix.image.tag-suffix || 'latest' }}-buildcache,mode=max
          tags: |
            ghcr.io/${{ github.repository_owner }}/${{ matrix.image.tag }}:${{ matrix.image.tag-suffix || 'latest' }}
            ${{ matrix.image.name == 'dev:dind' && format('ghcr.io/{0}/dev-base', github.repository_owner) || '' }}
            ${{ matrix.image.name == 'devcontainer:base' && format('ghcr.io/{0}/base', github.repository_owner) || '' }}
          push: true

  # Layer 3: Images that depend on dev:dind
  layer3-images:
    name: Build and Publish ${{ matrix.image.name }} Image
    runs-on: ubuntu-latest
    needs: [layer2-images]
    strategy:
      matrix:
        image:
          - name: devcontainer:dind
            context: ./images/devcontainer:dind
            tag: devcontainer
            tag-suffix: dind

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: Log into GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.image.context }}
          platforms: linux/amd64,linux/arm64
          cache-to: type=registry,ref=ghcr.io/${{ github.repository_owner }}/${{ matrix.image.tag }}:${{ matrix.image.tag-suffix }}-buildcache
          cache-from: type=registry,ref=ghcr.io/${{ github.repository_owner }}/${{ matrix.image.tag }}:${{ matrix.image.tag-suffix }}-buildcache,mode=max
          tags: ghcr.io/${{ github.repository_owner }}/${{ matrix.image.tag }}:${{ matrix.image.tag-suffix }}
          push: true

  features:
    name: Build and Publish Features
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: "Publish Features"
        uses: devcontainers/action@v1
        with:
          publish-features: "true"
          base-path-to-features: "./features/src"
          disable-repo-tagging: "true"
          features-namespace: "onezerocompany/devcontainers/features"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  devcontainers:
    name: Publish Pre-built Devcontainers
    runs-on: ubuntu-latest
    needs: [layer2-images, layer3-images, features]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: "Publish Devcontainers"
        uses: devcontainers/action@v1
        with:
          publish-templates: "true"
          base-path-to-templates: "./devcontainers"
          disable-repo-tagging: "true"
          templates-namespace: "onezerocompany/devcontainers"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
